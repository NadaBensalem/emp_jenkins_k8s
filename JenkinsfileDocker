pipeline {
    /* On dit à Jenkins d'exécuter le pipeline sur n'importe quel agent.
       ⚠ Cet agent doit avoir Docker installé et le droit d'exécuter "docker build / docker push". */
    agent any
    tools {
        // Déclare l'utilisation de la version de Maven configurée dans Jenkins (maven384)
         maven 'maven384'  // Nom de l'outil Maven configuré dans Jenkins
    }
    /* Variables globales */
    environment {
        // Nom local de l'image 
        backend_image = "emp_backend_img"
        frontend_image = "emp_frontend_img"
        
         // Sonarqube env 
        SONARQUBE_URL = 'http://localhost:9000'  
        SONAR_TOKEN = 'a3eb29305a87204344cb70bd743abf2fded33f76' 
        // Repo folders from repo GitHub
        
        backendF = "employee-management/emp_backend"
        frontendF = "employee-management/emp_frontend"

        // URL du repo GitHub
        GIT_REPO = "https://github.com/NadaBensalem/emp_app.git"
    }

    stages {

        // stage('clone projet from github') {
        //     steps {
        //         echo "==> Récupération du code source depuis GitHub"

        //         /* Clone le repo avec tes identifiants Jenkins ''
        //            - branch: mets 'main' ou 'master' selon ta branche */
        //         git branch: 'master',
        //             credentialsId: 'github-cred',
        //             url: "${GIT_REPO}"
        //     }
        // }

        stage('Build Docker Image emp -- backend') {
            steps {
                echo "==> Build de l'image Docker locale"

                /* On construit l'image Docker en tag 'latest'
                   Le Dockerfile doit être à la racine du repo */
                bat """
                    docker build -t ${backend_image}:latest ${backendF}
                """
            }
        }

        stage('Push Docker Image emp -- backend') {
            steps {
                echo "==> Push de l'image sur Docker Hub (tag: latest)"

                /* On utilise les identifiants Jenkins ''
                   ATTENTION :
                   - usernameVariable = ton username Docker Hub
                   - passwordVariable = le mot de passe / token Docker Hub
                */
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-cred',
                        usernameVariable: 'DOCKERHUB_USER',
                        passwordVariable: 'DOCKERHUB_PASS'
                    )]) {

                        // login Docker Hub
                        bat """
                           echo %DOCKERHUB_PASS% | docker login -u %DOCKERHUB_USER% --password-stdin
                        """

                        // retag l'image locale avec ton namespace Docker Hub
                        bat """
                            docker tag ${backend_image}:latest %DOCKERHUB_USER%/${backend_image}:latest
                            docker push %DOCKERHUB_USER%/${backend_image}:latest
                        """

                        // logout 
                        bat "docker logout"
                    }
                }
            }
        }

        // stage('Build Docker Image emp -- frontend') {
        //     steps {
        //         echo "==> Build de l'image Docker locale"

        //         /* On construit l'image Docker en tag 'latest'
        //            Le Dockerfile doit être à la racine du repo */
        //         bat """
        //             docker build -t ${frontend_image}:latest ${frontendF}
        //         """
        //     }
        // }

        // stage('Push Docker Image emp -- frontend') {
        //     steps {
        //         echo "==> Push de l'image sur Docker Hub (tag: latest)"

        //         /* On utilise les identifiants Jenkins ''
        //            ATTENTION :
        //            - usernameVariable = ton username Docker Hub
        //            - passwordVariable = le mot de passe / token Docker Hub
        //         */
        //         script {
        //             withCredentials([usernamePassword(
        //                 credentialsId: 'dockerhub-cred',
        //                 usernameVariable: 'DOCKERHUB_USER',
        //                 passwordVariable: 'DOCKERHUB_PASS'
        //             )]) {

        //                 // login Docker Hub
        //                 bat """
        //                      echo %DOCKERHUB_PASS% | docker login -u %DOCKERHUB_USER% --password-stdin
        //                 """

        //                 // retag l'image locale avec ton namespace Docker Hub
        //                 bat """
        //                     docker tag ${frontend_image}:latest %DOCKERHUB_USER%/${frontend_image}:latest
        //                     docker push %DOCKERHUB_USER%/${frontend_image}:latest
        //                 """

        //                 // logout 
        //                 bat "docker logout"
        //             }
        //         }
        //     }
        // }

        // stage('Run Containers with Docker Compose') {
        //     steps {
        //         echo "==> Lancement des conteneurs avec Docker Compose"
        //         script {
        //              // Exécute docker compose 
        //             bat """
        //              cd employee-management
        //              docker compose up -d
        //              """
        //         }
        //      }
        // }

        //  stage('SonarQube - Backend') {
        //      steps {
        //          dir('employee-management/emp_backend') {  // Entre dans le répertoire du projet backend
        //             echo "==> Test qualité de code ... "
        //             // Analyse SonarQube en utilisant Maven sur Windows
        //             bat """
        //                  mvn clean install -DskipTests ^
        //                  && mvn sonar:sonar ^
        //                 -Dsonar.projectKey=emp_backend ^
        //                 -Dsonar.host.url=%SONARQUBE_URL% ^
        //                 -Dsonar.login=%SONAR_TOKEN%
        //                 """
        //         }   
        //     }
        // }

         stage('Build du Projet et Déposer l\'artifact vers Nexus') {
            steps {
                script {
                    // 1. Effectuer le build dans le répertoire emp_backend
                    dir('employee-management/emp_backend') {
                        echo "==> Build du projet dans le répertoire emp_backend"
                        bat 'mvn clean install -DskipTests'  // Exécute le build dans le répertoire emp_backend
                    }

                    // 2. Déposer l'artefact vers Nexus
                    echo "==> Déposer l\'artifact vers Nexus"
                    nexusArtifactUploader artifacts: [
                        [
                            artifactId: 'emp_backend',
                            classifier: '',
                            file: 'employee-management/emp_backend/target/emp_backend-0.0.1-SNAPSHOT.jar',  // Chemin vers le JAR généré
                            type: 'jar'
                        ]
                    ],
                    credentialsId: 'nexus-cred',  // ID des credentials Jenkins pour Nexus
                    groupId: 'com.example',           // GroupId du projet
                    nexusUrl: 'localhost:8081',  // URL de Nexus
                    nexusVersion: 'nexus3',        // Version de Nexus
                    protocol: 'http',              // Protocole
                    repository: 'emp-jar-repo',        // Repository Nexus
                    version: '0.0.1-SNAPSHOT'     // Version de l'artefact
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline terminé."
        }
    }
}
